<%####################################################################### %>
<%# Copyright (c) 2014 ENEO TecnologÃ­a S.L. %>
<%# This file is part of redBorder. %>
<%# redBorder is free software: you can redistribute it and/or modify %>
<%# it under the terms of the GNU Affero General Public License License as published by %>
<%# the Free Software Foundation, either version 3 of the License, or %>
<%# (at your option) any later version. %>
<%# redBorder is distributed in the hope that it will be useful, %>
<%# but WITHOUT ANY WARRANTY; without even the implied warranty of %>
<%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the %>
<%# GNU Affero General Public License License for more details. %>
<%# You should have received a copy of the GNU Affero General Public License License %>
<%# along with redBorder. If not, see <http://www.gnu.org/licenses/>. %>
<%####################################################################### %>
###############################################################################
# Generated by Chef for <%= node[:hostname] %>
###############################################################################

<% if ((@vgroup["vlan_objects"] and @vgroup["vlan_objects"].size>0) or (@vgroup["network_objects"] and @vgroup["network_objects"].size>0)) %>
var BASE_PATH /etc/snort/<%= @group["instances_group"] %>
include $BASE_PATH/snort-common.conf
<% end %>

###################################################
# Set the network variables.
###################################################

dynamicdetection directory $BASE_PATH/snort-binding-<%= @vgroup["id"] %>/dynamicrules

include $BASE_PATH/snort-binding-<%= @vgroup["id"] %>/snort-variables.conf
<%= "include $BASE_PATH/snort-binding-#{@vgroup["id"]}/snort-variables.conf_local" if File.exists?"/etc/snort/#{@group["instances_group"]}/snort-binding-#{@vgroup["id"]}/snort-variables.conf_local" %>

###################################################
# Configure preprocessors
###################################################

<% if File.exists?"/etc/snort/#{@group["instances_group"]}/snort-binding-#{@vgroup["id"]}/snort-preprocessors.conf_local" %>
include $BASE_PATH/snort-binding-<%= @vgroup["id"] %>/snort-preprocessors.conf_local
<% else %>
include $BASE_PATH/snort-binding-<%= @vgroup["id"] %>/snort-preprocessors.conf
<% end %>

###################################################
# Customize your rule set
###################################################

<%- if @group["mode"] != "IPS_NR" %>
include $BASE_PATH/snort-binding-<%= @vgroup["id"] %>/snort.rules
<% end %>
<%= "include $BASE_PATH/snort-binding-#{@vgroup["id"]}/snort.rules_local" if File.exists?"/etc/snort/#{@group["instances_group"]}/snort-binding-#{@vgroup["id"]}/snort.rules_local" %>
##########################################################
# Customize your preprocessor and decoder alerts
#########################################################

include $BASE_PATH/snort-binding-<%= @vgroup["id"] %>/preprocessor.rules
<%= "include $BASE_PATH/snort-binding-#{@vgroup["id"]}/preprocessor.rules_local" if File.exists?"/etc/snort/#{@group["instances_group"]}/snort-binding-#{@vgroup["id"]}/preprocessor.rules_local" %>

##########################################################
##### Customize your reputation preprocessor rules
#############################################################

include $BASE_PATH/snort-binding-<%= @vgroup["id"] %>/reputation.rules
<%= "include $BASE_PATH/snort-binding-#{@vgroup["id"]}/reputation.rules_local" if File.exists?"/etc/snort/#{@group["instances_group"]}/snort-binding-#{@vgroup["id"]}/reputation.rules_local" %>

###################################################
# Thresholds 
###################################################

include $BASE_PATH/snort-binding-<%= @vgroup["id"] %>/threshold.conf
<%= "include $BASE_PATH/snort-binding-#{@vgroup["id"]}/threshold.conf_local" if File.exists?"/etc/snort/#{@group["instances_group"]}/snort-binding-#{@vgroup["id"]}/threshold.conf_local" %>

###########################
### Default event filtering #
#############################
event_filter \
  gen_id 0, sig_id 0, \
  type limit, track by_src_dst, \
  count <%= ( @vgroup["threshold_count"].nil? ? 5 : [ [ @vgroup["threshold_count"].to_i, 86400 ].min, 0 ].max ) %>, seconds <%= ( @vgroup["threshold_seconds"].nil? ? 60 : [ [ @vgroup["threshold_seconds"].to_i, 86400 ].min, 0 ].max ) %>

###################################################
# Save traffic on pcap files (debug) 
###################################################

<%- if @vgroup["save_pcap"] %>
output log_tcpdump: tcpdump.log
<% end %>

