<%####################################################################### %>
<%# Copyright (c) 2014 ENEO TecnologÃ­a S.L. %>
<%# This file is part of redBorder. %>
<%# redBorder is free software: you can redistribute it and/or modify %>
<%# it under the terms of the GNU Affero General Public License License as published by %>
<%# the Free Software Foundation, either version 3 of the License, or %>
<%# (at your option) any later version. %>
<%# redBorder is distributed in the hope that it will be useful, %>
<%# but WITHOUT ANY WARRANTY; without even the implied warranty of %>
<%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the %>
<%# GNU Affero General Public License License for more details. %>
<%# You should have received a copy of the GNU Affero General Public License License %>
<%# along with redBorder. If not, see <http://www.gnu.org/licenses/>. %>
<%####################################################################### %>
###############################################################################
# Generated by Chef for <%= node[:hostname] %>
###############################################################################

var BASE_PATH /etc/snort/<%= @group["instances_group"] %>
include $BASE_PATH/snort-common.conf

###################################################
# Configure binding
###################################################

<% default_added = false %>
<% @group["bindings"].keys.map{|x| x.to_i}.sort.map{|x| "#{x}"}.each do |id| %>
<% ob = @group["bindings"][id] %>
<% if ob["vlan_objects"] and ob["vlan_objects"].size>0 %> 
<% elsif ob["network_objects"] and ob["network_objects"].size>0 %> 
<% elsif !default_added %>
<% default_added = true %>
include $BASE_PATH/snort-binding-<%= id %>/snort.conf
<% end %>
<% end %>
<% if !default_added %>
<% end %>

<% @group["bindings"].each do |id, ob| %>
<% if ob["vlan_objects"] and ob["vlan_objects"].size>0 %> 
<% vlans=[] %>
<% ob["vlan_objects"].each do |kid, vob| %>
<% vob.each do |vname, vvalue| %>
<% v = nil %>
<% v = node["redborder"]["objects"]["vlans"][vname] if (node["redborder"]["objects"] and node["redborder"]["objects"]["vlans"] ) %>
<% v = vvalue if v.nil? %>
<% vlans<<v %>
<% end %>
<% end %>
config binding: $BASE_PATH/snort-binding-<%= id %>/snort.conf vlan <%= vlans.uniq.join(",") %>
<% end %>
<% if ob["network_objects"] and ob["network_objects"].size>0 %> 
<% networks=[] %>
<% ob["network_objects"].each do |kid, vob| %>
<% vob.each do |vname, vvalue| %>
<% v = nil %>
<% v = node["redborder"]["objects"]["networks"][vname] if (node["redborder"]["objects"] and node["redborder"]["objects"]["networks"] ) %>
<% v = node["redborder"]["objects"]["hosts"][vname] if (node["redborder"]["objects"] and node["redborder"]["objects"]["hosts"] ) %>
<% v = vvalue if v.nil? %>
<% networks<<v %>
<% end %>
<% end %>
config binding: $BASE_PATH/snort-binding-<%= id %>/snort.conf net <%= networks.uniq.join(",") %>
<% end %>
<% end %>
